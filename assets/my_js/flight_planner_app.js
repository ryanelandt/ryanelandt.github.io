function create_circle_black(){var t=new THREE.CircleGeometry(1*puck_size,32),e=new THREE.MeshBasicMaterial({color:0});return new THREE.Mesh(t,e)}function create_circle_transparent(){var t=new THREE.CircleGeometry(1*puck_size,32),e=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:0});return new THREE.Mesh(t,e)}function createMarker(t){return t.position.set(0,0,-1e3),t.rotation.setFromRotationMatrix(camera_vectors.uv_mat),t}function createMarkerClear(){return createMarker(create_circle_transparent())}function createMarkerPath(){return createMarker(create_circle_black())}function createCylGeoForHeight(t,e){return new THREE.CylinderGeometry(t,t,e,16,1,!1)}function createNewCylinder(t){const e=createCylGeoForHeight(t,1),r=new THREE.MeshBasicMaterial({color:65280}),i=new THREE.Mesh(e,r);return scene.add(i),i}function adjustCylinder(t,e,r,i=!1){const[n,a,s]=e,[o,c,l]=r;var d=100;d=i?t.geometry.parameters.height:Math.sqrt((o-n)**2+(c-a)**2+(l-s)**2);const h=t.geometry.parameters.radiusTop;t.geometry.dispose(),t.geometry=createCylGeoForHeight(h,d),t.position.set((n+o)/2,(a+c)/2,(s+l)/2);const _=new THREE.Vector3(o-n,c-a,l-s).normalize();t.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),_)}function initGeometry(){var t=(helper_cpp=new CppArrayPointerHelper(909)).loadCityData();for(let e=0;e<t.length;e++){const r=new City(e,new THREE.Vector3(t[e][0],t[e][1],t[e][2]));vCity.push(r)}const e=createCylGeoForHeight(puck_size,puck_height);var r=createCylGeoForHeight(2*puck_size,.5*puck_height),i=new THREE.MeshBasicMaterial({color:rgb_puck_outer,side:THREE.BackSide});markers=new Markers;for(let t=0;t<vCity.length;t++){const s=new THREE.Mesh(e,new THREE.MeshBasicMaterial({color:rgb_puck_inner})),o=vCity[t].getPosition();s.material.depthTest=!0,adjustCylinder(s,[0,0,0],o,!0);var n=new THREE.Mesh(r,i);adjustCylinder(n,[0,0,0],o,!0),s.position.set(vCity[t].getPosition().x,vCity[t].getPosition().y,vCity[t].getPosition().z),n.position.set(vCity[t].getPosition().x,vCity[t].getPosition().y,vCity[t].getPosition().z);var a=new THREE.Group;a.add(s),a.add(n),scene.add(a),v_city_puck_inner.push(s),v_city_puck_outer.push(n),dictObIdToCityId[s.id]=t,dictObIdToCityId[n.id]=t}markers.initText()}function init(){canvas_holder=document.getElementById("canvas-holder"),camera_vectors=new CameraVectors,canvas_helper=new CanvasHelper,camera=canvas_helper.create_camera(),raycaster=new THREE.Raycaster,(renderer=new THREE.WebGLRenderer).setPixelRatio(window.devicePixelRatio),(labelRenderer=new CSS2DRenderer).domElement.style.position="absolute",canvas_holder.appendChild(labelRenderer.domElement),canvas_helper.set_canvas_holder_size(canvas_holder,renderer,labelRenderer),canvas_holder.appendChild(renderer.domElement),(scene=new THREE.Scene).background=new THREE.Color(12632256);const t=new THREE.DirectionalLight(16777215,1);t.position.set(-150,-1050,800).normalize(),scene.add(t),initGeometry(),document.addEventListener("mousedown",onDocumentMouseDown,!1),window.addEventListener("resize",onWindowResize),render()}function onDocumentMouseDown(t){function e(t){const e=t.intersectObjects(v_city_puck_inner,!0);if(0!=e.length)return dictObIdToCityId[e[0].object.id];const r=t.intersectObjects(v_city_puck_outer,!0);if(0!=r.length){const t=r[0];return dictObIdToCityId[t.object.id]}return null}const r=renderer.domElement.getBoundingClientRect();mouse_xy.x=(t.clientX-r.left)/(r.right-r.left)*2-1,mouse_xy.y=-(t.clientY-r.top)/(r.bottom-r.top)*2+1,raycaster.setFromCamera(mouse_xy,camera);const i=e(raycaster);if(null==i)return;const n=v_city_puck_inner[i].id;markers.updateMarkers(n),drawPath(),render()}function drawPath(){if(2!=markers.vStartEndCity.length)return;var t=helper_cpp.loadPathReal(dictObIdToCityId[markers.vStartEndCity[0]],dictObIdToCityId[markers.vStartEndCity[1]]);console.log("Printing v_id_path"+t);const e=[];for(let n=0;n<t.length;n++){var r=t[n],i=vCity[r].getPosition();0!=n&&i.equals(e[e.length-1])||e.push(i)}const n=e.length-1;for(let t=v_cylinders.length;t<n;t++){const t=createNewCylinder(path_rad);t.material.color.set(rgb_path),v_cylinders.push(t)}for(let t=0;t<v_cylinders.length;t++){v_cylinders[t].position.set(0,0,-1e3)}const a=markers.getCityIdLast();for(let t=1;t<e.length;t++){const r=v_cylinders[t-1],i=e[t-1],n=e[t];setTimeout(()=>{a==markers.getCityIdLast()&&(adjustCylinder(r,i,n),render())},70*t)}}function onWindowResize(){console.log("CW"+canvas_holder.clientWidth+" CH"+canvas_holder.clientHeight),canvas_helper.set_canvas_holder_size(canvas_holder,renderer,labelRenderer),render()}function render(){camera.position.set(-168,-1e3,800),camera.lookAt(0,0,0),camera.rotation.setFromRotationMatrix(camera_vectors.uv_mat),camera.updateMatrixWorld(),renderer.render(scene,camera),labelRenderer.render(scene,camera),console.log("render")}import*as THREE from"./three.module.min.js";import{CSS2DRenderer,CSS2DObject}from"./CSS2DRenderer.js";import Module from"./flight_planner.js";let ModObj,canvas_holder,canvas_helper,helper_cpp,camera,scene,raycaster,renderer,labelRenderer,markers,camera_vectors;Module().then(t=>{ModObj=t,console.log("Promise resolved!"),init()});const rgb_puck_inner=16768443,rgb_puck_outer=3769444,rgb_path=8942126,path_rad=1.6,puck_size=3.5,puck_height=.4,EARTH_RAD=500,puck_dist_prop=1.0001,mouse_xy=new THREE.Vector2;let v_cylinders=[],vCity=[],v_city_puck_inner=[],v_city_puck_outer=[],dictObIdToCityId={};class CppArrayPointerHelper{constructor(t){if("number"!=typeof t)throw new Error("n must be an integer");this.dataPtr=ModObj._malloc(8*t),this.n=t,this.lengthPtr=ModObj._malloc(4)}getLength(){return ModObj.getValue(this.lengthPtr,"i32")}free(){ModObj._free(this.dataPtr),ModObj._free(this.lengthPtr)}loadCityData(){ModObj.ccall("voidAirportXyz","void",["number","number"],[this.dataPtr,this.lengthPtr]);for(var t=new Float64Array(ModObj.HEAPF64.buffer,this.dataPtr,this.n),e=[],r=0;r<this.getLength();r+=3)e.push([t[r]*EARTH_RAD,t[r+1]*EARTH_RAD,t[r+2]*EARTH_RAD]);return e}loadPathReal(t,e){ModObj.ccall("voidPathOutReal","void",["number","number","number","number"],[this.dataPtr,this.lengthPtr,t,e]);for(var r=new Float64Array(ModObj.HEAPF64.buffer,this.dataPtr,this.n),i=[],n=0;n<this.getLength();++n){var a=r[n],s=Math.round(a);if(s!=a)throw new Error("ind is not an integer");i.push(s)}return i}get_city_string_for_id(t){ModObj.ccall("getCityName","void",["number","number","number"],[this.dataPtr,this.lengthPtr,t]);for(var e=new Float64Array(ModObj.HEAPF64.buffer,this.dataPtr,this.n),r="",i=0;i<this.getLength();++i){var n=e[i],a=Math.round(n);if(a!=n)throw new Error("ind is not an integer");r+=String.fromCharCode(a)}return r}}class CanvasHelper{constructor(){this.aspect_ratio_=1.7,this.width_min_=400,this.frustumSize_=215}create_camera(){const t=this.frustumSize();return new THREE.OrthographicCamera(t*this.aspect_ratio_/-2,t*this.aspect_ratio_/2,t/2,t/-2,1,1e3)}set_canvas_holder_size(t,e,r){const i=t.clientWidth,n=i/this.aspect_ratio();t.style.height=n+"px",e.setSize(i,n),r.setSize(i,n),this.print_canvas_holder_size(t)}print_canvas_holder_size(t){const e=t.clientWidth,r=t.clientHeight;console.log("width: "+e+" height: "+r)}aspect_ratio(){return this.aspect_ratio_}width_min(){return this.width_min_}frustumSize(){return this.frustumSize_}}class CameraVectors{constructor(){this.lookAt=new THREE.Vector3(0,0,0),this.uv_z=new THREE.Vector3(-165,-990,800).normalize();const t=new THREE.Vector3(1,-.32,0).normalize();this.uv_y=(new THREE.Vector3).crossVectors(this.uv_z,t).normalize(),this.uv_x=(new THREE.Vector3).crossVectors(this.uv_y,this.uv_z).normalize(),this.uv_mat=new THREE.Matrix4,this.uv_mat.set(this.uv_x.x,this.uv_y.x,this.uv_z.x,0,this.uv_x.y,this.uv_y.y,this.uv_z.y,0,this.uv_x.z,this.uv_y.z,this.uv_z.z,0,0,0,0,1)}getUvIntoViewer(){return this.uv_z.negate()}}class Markers{constructor(){this.mark_path_last=createMarkerPath(),this.mark_path_snl=createMarkerPath(),this.mark_txt_last=createMarkerClear(),scene.add(this.mark_path_last),scene.add(this.mark_path_snl),scene.add(this.mark_txt_last),this.vStartEndCity=[],this.mark_txt_div=this.createTextDiv()}createTextDiv(){const t=document.createElement("div");return t.className="label",t.innerHTML="",t.style.backgroundColor="transparent",t.style.color="black",t.style.fontSize="18px",t}setObjPosition(t,e,r){const i=camera_vectors.uv_x,n=camera_vectors.uv_y;var a=camera_vectors.uv_z.clone();a.add(i.clone().multiplyScalar(e)),a.add(n.clone().multiplyScalar(r)),a.normalize(),a.multiplyScalar(EARTH_RAD*puck_dist_prop),t.position.set(a.x,a.y,a.z)}recordClickedCities(t){if(this.vStartEndCity.length<=1)return this.vStartEndCity.push(t),-1;{const e=this.vStartEndCity.shift();return this.vStartEndCity.push(t),e}}updateMarkers(t){this.recordClickedCities(t);const e=this.getCityIdLast();this.setObjPositionToCity(e,this.mark_path_last),this.setObjPosition(this.mark_txt_last,-.393,-.2105),this.setDivTextToCityName();const r=this.getCityIdSnl();null!=r&&this.setObjPositionToCity(r,this.mark_path_snl)}getCityIdLast(){if(0==this.vStartEndCity.length)return null;const t=this.vStartEndCity[this.vStartEndCity.length-1];return dictObIdToCityId[t]}getCityIdSnl(){if(1==this.vStartEndCity.length)return null;const t=this.vStartEndCity[this.vStartEndCity.length-2];return dictObIdToCityId[t]}setObjPositionToCity(t,e){var r=vCity[t].getPosition().clone().multiplyScalar(1.01);e.position.set(r.x,r.y,r.z)}initText(){this.attachTextToObject(this.mark_txt_last,this.mark_txt_div)}setDivTextToCityName(){const t=this.getCityIdLast(),e=helper_cpp.get_city_string_for_id(t);this.mark_txt_div.innerHTML=e}attachTextToObject(t,e){t.layers.enableAll();const r=new CSS2DObject(e),i=9;r.position.set(i,0,0),r.center.set(0,.5),t.add(r),r.layers.set(0)}}class City{constructor(t,e){this.id=t,this.position=e}getId(){return this.id}getPosition(){return this.position}}